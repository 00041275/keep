# Database disk space is low (<10%)
alert:
  id: db-disk-space
  description: Check that the DB has enough disk space
  owners:
    - github-shahargl
    - slack-talboren
  services:
    - db
    - api
  trigger:
    # Run every hour or if the service-is-failing alert is triggered
    interval: 1h
    event:
      - id: service-is-failing
        type: alert
  steps:
    - name: db-no-space
      from: db-server
      command: df -h | grep /dev/sda1 | awk '{ print $4} ' # Check the disk space
      threshold: 90% # Trigger if more than 90% full
      on_failure: # What to do if the SSH connection failed?
        - name: ssh-connection-failed
          retry: 5 # Retry 5 times
          alert: true # Finally, alert
  actions:
    - name: trigger-slack
      host: slack
      channel: db-is-down
      template: slack-error-template
      context:
        - name: db-name
          value: "{{ hosts.db-server.name }}"
        - name: disk-space
          value: "{{ steps.db-no-space.command.output }}"
